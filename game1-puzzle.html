<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>拼圖 + 問答遊戲</title>
<style>
body { font-family: "Noto Sans TC", sans-serif; text-align:center; }
#puzzle-container { position: relative; width: 360px; height: 360px; margin: 20px auto; background-color: #000; display: grid; grid-template-columns: repeat(3, 120px); grid-template-rows: repeat(3, 120px); gap: 0; }
.slot { border: 1px solid #111; width: 120px; height: 120px; box-sizing: border-box; }
.piece { width: 120px; height: 120px; background-size: 360px 360px; border: 2px solid red; position: absolute; cursor: grab; touch-action: none; }
#startBtn { margin: 10px; padding: 10px 20px; font-size: 16px; }
#timer { font-weight: bold; margin-bottom: 10px; }
#desc { margin-bottom: 10px; }
.hidden { display: none; }
#quiz { margin-top: 20px; }
button.quiz-option { margin:5px; padding:10px 15px; font-size:16px; }
</style>
</head>
<body>

<h2>拼圖 + 問答遊戲</h2>
<p id="desc">按下開始，5秒內記憶完整圖片</p>
<div id="timer"></div>
<button id="startBtn">開始遊玩</button>

<div id="puzzle-container"></div>

<div id="quiz" class="hidden">
  <p id="question">問題文字</p>
  <div id="options"></div>
</div>

<script>
const fullImage = 'img/puzzle.jpg';
const container = document.getElementById('puzzle-container');
const startBtn = document.getElementById('startBtn');
const desc = document.getElementById('desc');
const timerDisplay = document.getElementById('timer');
const quiz = document.getElementById('quiz');
const questionEl = document.getElementById('question');
const optionsEl = document.getElementById('options');

let pieces = [];
let dragging = null;
let offsetX=0, offsetY=0;
let correctCount = 0;

// 題庫範例
const quizData = {
  question: "這張圖片中共有幾塊拼圖？",
  options: ["6", "9", "12", "15"],
  answer: "9"
};

// 建立 3x3 目標格子
function createSlots() {
  container.innerHTML = '';
  for(let i=0;i<9;i++){
    const slot = document.createElement('div');
    slot.className = 'slot';
    slot.dataset.index = i;
    container.appendChild(slot);
  }
}

// 建立拼圖塊，散落在容器外
function createPieces() {
  pieces = [];
  for(let i=0;i<9;i++){
    const div = document.createElement('div');
    div.className = 'piece';
    div.style.backgroundImage = `url(${fullImage})`;
    div.style.backgroundPosition = `${-120*(i%3)}px ${-120*Math.floor(i/3)}px`;
    div.dataset.index = i;
    div.style.left = Math.random()*240 + 'px';
    div.style.top = Math.random()*240 + 'px';
    container.appendChild(div);
    pieces.push(div);
    addDragEvents(div);
  }
}

// 拖曳事件
function addDragEvents(el){
  el.addEventListener('mousedown', startDrag);
  el.addEventListener('touchstart', startDrag);
}
function startDrag(e){
  e.preventDefault();
  dragging = e.target;
  const rect = dragging.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();
  if(e.touches){
    offsetX = e.touches[0].clientX - rect.left;
    offsetY = e.touches[0].clientY - rect.top;
  }else{
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
  }
  window.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
  window.addEventListener('touchmove', moveDrag);
  window.addEventListener('touchend', endDrag);
}
function moveDrag(e){
  if(!dragging) return;
  let clientX, clientY;
  if(e.touches){ clientX=e.touches[0].clientX; clientY=e.touches[0].clientY; }
  else{ clientX=e.clientX; clientY=e.clientY; }
  const containerRect = container.getBoundingClientRect();
  dragging.style.left = clientX - containerRect.left - offsetX + 'px';
  dragging.style.top = clientY - containerRect.top - offsetY + 'px';
}
function endDrag(e){
  if(!dragging) return;
  const index = parseInt(dragging.dataset.index);
  const slot = container.children[index];
  const slotRect = slot.getBoundingClientRect();
  const pieceRect = dragging.getBoundingClientRect();
  const margin = 30; // 誤差範圍
  if(pieceRect.left + pieceRect.width/2 > slotRect.left - margin &&
     pieceRect.left + pieceRect.width/2 < slotRect.right + margin &&
     pieceRect.top + pieceRect.height/2 > slotRect.top - margin &&
     pieceRect.top + pieceRect.height/2 < slotRect.bottom + margin){
    // 放對，固定位置
    dragging.style.left = slot.offsetLeft + 'px';
    dragging.style.top = slot.offsetTop + 'px';
    dragging.style.border = 'none';
    dragging.style.cursor = 'default';
    dragging.removeEventListener('mousedown', startDrag);
    dragging.removeEventListener('touchstart', startDrag);
    correctCount++;
    if(correctCount===9){
      showQuiz();
    }
  }
  dragging = null;
  window.removeEventListener('mousemove', moveDrag);
  window.removeEventListener('mouseup', endDrag);
  window.removeEventListener('touchmove', moveDrag);
  window.removeEventListener('touchend', endDrag);
}

// 顯示問答題
function showQuiz(){
  quiz.classList.remove('hidden');
  questionEl.innerText = quizData.question;
  optionsEl.innerHTML = '';
  quizData.options.forEach(opt=>{
    const btn = document.createElement('button');
    btn.innerText = opt;
    btn.className = 'quiz-option';
    btn.addEventListener('click', ()=>{
      if(opt===quizData.answer) alert('答對了！');
      else alert('答錯了，再試一次');
    });
    optionsEl.appendChild(btn);
  });
}

// 開始遊戲
startBtn.addEventListener('click', ()=>{
  createSlots();
  container.innerHTML = `<img src="${fullImage}" style="width:360px;height:360px;position:absolute;left:0;top:0;">`;
  desc.innerText = '請在5秒內記住完整圖片';
  let countdown=5;
  timerDisplay.innerText = `倒數: ${countdown}秒`;
  const interval = setInterval(()=>{
    countdown--;
    timerDisplay.innerText = `倒數: ${countdown}秒`;
    if(countdown<=0){
      clearInterval(interval);
      timerDisplay.innerText = '';
      desc.innerText = '請將拼圖拖入正確位置';
      createSlots();
      createPieces();
    }
  },1000);
});
</script>

</body>
</html>
