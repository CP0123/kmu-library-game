<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>拼圖遊戲</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: "Noto Sans TC", sans-serif; text-align:center; }
  #puzzle-container { position: relative; width: 600px; height: 400px; margin: 20px auto; border: 1px solid #ccc; }
  #slots { position: absolute; left: 150px; top: 50px; display: grid; grid-template-columns: repeat(3,100px); gap: 2px; width: 300px; height: 300px; }
  .slot { width: 100px; height: 100px; border: 2px dashed #999; box-sizing: border-box; }
  .piece { width: 100px; height: 100px; background-size: 300px 300px; border: 2px solid red; position: absolute; cursor: grab; touch-action: none; }
  #startBtn { margin: 10px; padding: 10px 20px; font-size: 16px; }
  #timer { font-weight: bold; margin-bottom: 10px; }
  .hidden { display: none; }
</style>
</head>
<body>

<h2>拼圖遊戲</h2>
<p id="desc">按下開始，5秒內記憶完整圖片</p>
<div id="timer"></div>
<button id="startBtn">開始遊玩</button>
<div id="puzzle-container">
  <div id="slots"></div>
</div>

<script>
const fullImage = 'img/puzzle.jpg';
const container = document.getElementById('puzzle-container');
const slots = document.getElementById('slots');
const startBtn = document.getElementById('startBtn');
const desc = document.getElementById('desc');
const timerDisplay = document.getElementById('timer');

let pieces = [];
let dragging = null;
let offsetX=0, offsetY=0;
let correctCount = 0;

function createSlots() {
  slots.innerHTML = '';
  for(let i=0;i<9;i++){
    const slot = document.createElement('div');
    slot.className = 'slot';
    slot.dataset.index = i;
    slots.appendChild(slot);
  }
}

function createPieces() {
  pieces = [];
  for(let i=0;i<9;i++){
    const div = document.createElement('div');
    div.className = 'piece';
    div.style.backgroundImage = `url(${fullImage})`;
    div.style.backgroundPosition = `${-100*(i%3)}px ${-100*Math.floor(i/3)}px`;
    div.dataset.index = i;
    // 隨機散落
    div.style.left = Math.random()*500 + 'px';
    div.style.top = Math.random()*300 + 'px';
    container.appendChild(div);
    pieces.push(div);
    addDragEvents(div);
  }
}

// 拖曳事件 (支援桌機+手機)
function addDragEvents(el){
  el.addEventListener('mousedown', startDrag);
  el.addEventListener('touchstart', startDrag);
}
function startDrag(e){
  e.preventDefault();
  dragging = e.target;
  const rect = dragging.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();
  if(e.touches){
    offsetX = e.touches[0].clientX - rect.left;
    offsetY = e.touches[0].clientY - rect.top;
  }else{
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
  }
  window.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
  window.addEventListener('touchmove', moveDrag);
  window.addEventListener('touchend', endDrag);
}
function moveDrag(e){
  if(!dragging) return;
  let clientX, clientY;
  if(e.touches){ clientX=e.touches[0].clientX; clientY=e.touches[0].clientY; }
  else{ clientX=e.clientX; clientY=e.clientY; }
  const containerRect = container.getBoundingClientRect();
  dragging.style.left = clientX - containerRect.left - offsetX + 'px';
  dragging.style.top = clientY - containerRect.top - offsetY + 'px';
}
function endDrag(e){
  if(!dragging) return;
  // 判斷是否放入正確格子
  const index = parseInt(dragging.dataset.index);
  const slot = slots.children[index];
  const slotRect = slot.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();
  const pieceRect = dragging.getBoundingClientRect();
  const margin = 20; // 誤差範圍
  if(pieceRect.left + pieceRect.width/2 > slotRect.left - margin &&
     pieceRect.left + pieceRect.width/2 < slotRect.right + margin &&
     pieceRect.top + pieceRect.height/2 > slotRect.top - margin &&
     pieceRect.top + pieceRect.height/2 < slotRect.bottom + margin){
    // 放對，固定位置
    dragging.style.left = slot.offsetLeft + 'px';
    dragging.style.top = slot.offsetTop + 'px';
    dragging.style.border = 'none';
    dragging.style.cursor = 'default';
    dragging.removeEventListener('mousedown', startDrag);
    dragging.removeEventListener('touchstart', startDrag);
    correctCount++;
    if(correctCount===9){
      alert('恭喜完成拼圖！');
    }
  }
  dragging = null;
  window.removeEventListener('mousemove', moveDrag);
  window.removeEventListener('mouseup', endDrag);
  window.removeEventListener('touchmove', moveDrag);
  window.removeEventListener('touchend', endDrag);
}

// 顯示完整圖片5秒 + 倒數
startBtn.addEventListener('click', ()=>{
  createSlots();
  container.innerHTML = `<img src="${fullImage}" style="width:300px;height:300px;position:absolute;left:150px;top:50px;">`;
  desc.innerText = '請在5秒內記住完整圖片';
  let countdown=5;
  timerDisplay.innerText = `倒數: ${countdown}秒`;
  const interval = setInterval(()=>{
    countdown--;
    timerDisplay.innerText = `倒數: ${countdown}秒`;
    if(countdown<=0){
      clearInterval(interval);
      timerDisplay.innerText = '';
      desc.innerText = '請將拼圖拖入正確位置';
      container.innerHTML = '';
      createSlots();
      createPieces();
    }
  },1000);
});
</script>
</body>
</html>
